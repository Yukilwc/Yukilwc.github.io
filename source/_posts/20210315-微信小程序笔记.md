---
title: '微信小程序笔记'
categories:
- 其他
tags: 
- 收集
description: 微信小程序的坑点，技巧等
cover: https://blog-misaka1033.oss-cn-beijing.aliyuncs.com/blog/images/84197684_p0.webp
---

# 经验记录

## echarts与弹窗的覆盖问题

### 描述

> 当页面同时存在echarts，也就是canvas组件，和弹窗时，蒙层无法覆盖原生组件的问题

### 解决

canvas 2d的一个重大更新，就是支持了[同层渲染 ](https://developers.weixin.qq.com/community/develop/article/doc/000c4e433707c072c1793e56f5c813),
也就是说，是可以使用定位的z-index，来进行覆盖的.小程序会将原生组件渲染到web层视图层级中.

[同层渲染支持组件看这里](https://developers.weixin.qq.com/miniprogram/dev/component/native-component.html#%E5%8E%9F%E7%94%9F%E7%BB%84%E4%BB%B6%E5%90%8C%E5%B1%82%E6%B8%B2%E6%9F%93)

由于我先入为主，使用了cover-view覆盖，而cover-view对样式差劲的支持，导致陷入泥潭.

也就是说，只需要正常得使用定位覆盖即可。

特别注意!开发者工具上，canvas是无法被覆盖的，会误导开发者，而在真机上，是可以的。因此，以后注意，凡是涉及原生组件，一定不要相信开发者工具的显示，要在真机上看渲染效果.

### 截图

![调试工具canvas 2d不会被覆盖](https://blog-misaka1033.oss-cn-beijing.aliyuncs.com/blog/images/微信图片_20210314165942.png)

![真机canvas 2d可以被覆盖](https://blog-misaka1033.oss-cn-beijing.aliyuncs.com/blog/images/微信图片_20210314165949.jpg)

## 小程序分页页面的loading控制

### 描述

分页页面中，自身存在的状态较多，如果还划分了tab，则更加杂乱，控制混乱的状态，非常容易引起bug，例如无限loading，莫名的显示加载完成等

### 方案

划分状态=>构造wxml=>构造data=>js交互控制

* pageLoading, 页面loading，如果页面接口对页面布局有很大影响，那么就需要页面loading，其放在页面顶层，和内容区域互斥
* showEmpty: 当结果为空，或者异常出现时，显示该元素,一般其与列表容器同级别，并形成互斥，即if else
* listLoading: 其用于列表刷新级别的loading，以及下拉加载loading，与列表项同级，始终在列表最底部
* listLoadingComplete: listLoading的内部状态，当下拉到分页极限时，用来显示加载完成
* list: list数组自身对于加载显示有着重要影响，一般下拉刷新时，会清空该数组，产生明显的刷新感觉
* page: 分页信息，包含pageSize，pageNo和total
* 其他筛选级别信息，例如顶部的tab切换

关于js交互控制，由于状态繁多,控制容易产生遗漏，导致bug，所以总结一些经验

接口函数的纯粹性。一般来说,接口函数除了获取数据，还负担了处理异常，显示空状态，结束loading等UI层相关的任务，但是这里的分页接口不可承担，因为需要调用接口的情景多，每种情景都是不同的loading，空判定，初始状态，强行全部兼容到一个函数，容易产生高复杂。因为，接口函数仅对list做修改，即将新数据获取后，添加到list尾部，不对其他状态做处理，包括list自身的初始化.

UI层控制提升到上层触发加载的函数中。也就是，提升到initData,pullDownRefresh,reachBottom,中，此处注意，这些函数，按照接口调用前后划分，调用前后，**必须进行上述全部状态的修正,不可以只修正一部分,防止未知状态的混乱不可控**,也就是说，并不是一个状态决定了页面显示，而是上述状态集合，凡是变动，必须集中同一变动，防止从四处零碎的修改，最终产生一个位置的状态集合，引起不可控。例如，当下拉刷新，会关闭pageLoading，关闭showEmpty，关闭listLoading，清空list，page设置第一页，刷新接口调用完成后,可以只更新部分，list赋值或者empty置空，因为上下文之间是一致的，不会引起不可控的分散。

分页尽头的判定

### 分页框架的实现

详细见小程序实例工程内